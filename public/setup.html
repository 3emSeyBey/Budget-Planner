<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Setup - Smart Budget Planner</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .setup-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
        }
        .btn-setup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            transition: transform 0.3s ease;
        }
        .btn-setup:hover {
            transform: translateY(-2px);
            color: white;
        }
        .status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="setup-card">
        <div class="text-center mb-4">
            <i class="fas fa-database fa-3x text-primary mb-3"></i>
            <h2>Database Setup</h2>
            <p class="text-muted">Initialize your Smart Budget Planner database</p>
        </div>
        
        <div class="mb-4">
            <h5>Before you start:</h5>
            <ul class="list-unstyled">
                <li><i class="fas fa-check text-success me-2"></i>Make sure you have a database connection string</li>
                <li><i class="fas fa-check text-success me-2"></i>Set the DATABASE_URL environment variable in Vercel</li>
                <li><i class="fas fa-check text-success me-2"></i>This will create all necessary tables and default data</li>
            </ul>
        </div>
        
        <div class="d-grid gap-2">
            <button class="btn btn-setup" onclick="testAPI()">
                <i class="fas fa-heartbeat me-2"></i>Test API Connection
            </button>
            <button class="btn btn-setup" onclick="testDatabase()">
                <i class="fas fa-vial me-2"></i>Test Database Connection
            </button>
            <button class="btn btn-setup" onclick="setupDatabase()">
                <i class="fas fa-cog me-2"></i>Initialize Database
            </button>
        </div>
        
        <div id="status" class="status"></div>
        
        <div class="text-center mt-4">
            <a href="/" class="text-decoration-none">
                <i class="fas fa-arrow-left me-2"></i>Back to Budget Planner
            </a>
        </div>
    </div>

    <script>
        async function testAPI() {
            const status = document.getElementById('status');
            status.style.display = 'none';
            
            try {
                const response = await fetch('/api/health');
                const result = await response.json();
                
                if (result.success) {
                    status.className = 'status success';
                    status.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>API Test Results:</strong>
                        <br><strong>Status:</strong> ${result.message}
                        <br><strong>Environment:</strong> ${JSON.stringify(result.environment, null, 2)}
                        <br><strong>Timestamp:</strong> ${result.timestamp}
                    `;
                } else {
                    throw new Error(result.message || 'API test failed');
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>API Test Failed:</strong> ${error.message}
                    <br><small>This means the API endpoints are not working. Check your Vercel deployment.</small>
                `;
            }
            status.style.display = 'block';
        }

        async function testDatabase() {
            const status = document.getElementById('status');
            status.style.display = 'none';
            
            try {
                const response = await fetch('/api/test-db');
                const result = await response.json();
                
                if (result.success) {
                    status.className = 'status success';
                    status.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Database Test Results:</strong>
                        <br><strong>Environment:</strong> ${JSON.stringify(result.environment, null, 2)}
                        <br><strong>Database Status:</strong> ${result.database.status}
                        ${result.database.error ? `<br><strong>Error:</strong> ${result.database.error}` : ''}
                    `;
                } else {
                    throw new Error(result.message || 'Test failed');
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Test Failed:</strong> ${error.message}
                    <br><small>This usually means the DATABASE_URL environment variable is not set correctly.</small>
                `;
            }
            status.style.display = 'block';
        }

        async function setupDatabase() {
            const buttons = document.querySelectorAll('.btn-setup');
            const status = document.getElementById('status');
            
            // Show loading state
            buttons.forEach(btn => {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Setting up database...';
                btn.disabled = true;
            });
            status.style.display = 'none';
            
            try {
                const response = await fetch('/api/setup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    status.className = 'status success';
                    status.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Success!</strong> ${result.message}
                        <br><small>Database initialized with ${result.statements_executed} statements.</small>
                        ${result.warnings ? `<br><small><strong>Warnings:</strong> ${result.warnings.join(', ')}</small>` : ''}
                    `;
                    status.style.display = 'block';
                    
                    // Update buttons
                    buttons.forEach(btn => {
                        btn.innerHTML = '<i class="fas fa-check me-2"></i>Database Ready';
                        btn.className = 'btn btn-success';
                    });
                    
                    // Redirect to main app after 3 seconds
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 3000);
                } else {
                    throw new Error(result.message || 'Setup failed');
                }
            } catch (error) {
                status.className = 'status error';
                status.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${error.message}
                    <br><small>Please check your database connection and try again.</small>
                `;
                status.style.display = 'block';
                
                // Reset buttons
                buttons.forEach((btn, index) => {
                    if (index === 0) {
                        btn.innerHTML = '<i class="fas fa-heartbeat me-2"></i>Test API Connection';
                    } else if (index === 1) {
                        btn.innerHTML = '<i class="fas fa-vial me-2"></i>Test Database Connection';
                    } else {
                        btn.innerHTML = '<i class="fas fa-cog me-2"></i>Initialize Database';
                    }
                    btn.disabled = false;
                });
            }
        }
    </script>
</body>
</html>
